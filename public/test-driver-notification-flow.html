<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Notification Flow Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        
        button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 8px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
        }
        
        .websocket-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .connected { background: #28a745; }
        .disconnected { background: #dc3545; }
        .connecting { background: #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸš— Driver Notification Flow Test</h1>
        <p>This page tests the complete flow from booking creation to driver notification via WebSocket.</p>
        
        <div class="test-section">
            <h3>ðŸ”Œ Step 1: WebSocket Connection Test</h3>
            <div id="wsStatus" class="status info">
                <span class="websocket-status disconnected"></span>
                WebSocket: Disconnected
            </div>
            <button onclick="connectWebSocket()">Connect WebSocket</button>
            <button onclick="disconnectWebSocket()">Disconnect WebSocket</button>
            <div id="wsLog" class="log"></div>
        </div>
        
        <div class="test-section">
            <h3>ðŸ‘¥ Step 2: Check Connected Drivers</h3>
            <div id="driverStatus" class="status info">Checking connected drivers...</div>
            <button onclick="checkConnectedDrivers()">Check Connected Drivers</button>
            <div id="driverLog" class="log"></div>
        </div>
        
        <div class="test-section">
            <h3>ðŸš€ Step 3: Create Test Booking</h3>
            <div id="bookingStatus" class="status info">Ready to create test booking</div>
            <button onclick="createTestBooking()">Create Test Booking</button>
            <button onclick="createBookingWithDriver()">Create Booking for Specific Driver</button>
            <div id="bookingLog" class="log"></div>
        </div>
        
        <div class="test-section">
            <h3>ðŸ“± Step 4: Monitor Notifications</h3>
            <div id="notificationStatus" class="status info">Waiting for notifications...</div>
            <button onclick="clearAllLogs()">Clear All Logs</button>
            <div id="notificationLog" class="log"></div>
        </div>
        
        <div class="test-section">
            <h3>ðŸ”„ Step 5: Complete Flow Test</h3>
            <button onclick="runCompleteTest()">Run Complete Test</button>
            <div id="completeTestLog" class="log"></div>
        </div>
    </div>

    <script>
        let ws = null;
        let isConnected = false;
        let testDriverId = 'testdriver';
        
        function log(elementId, message) {
            const logDiv = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateStatus(elementId, type, message) {
            const statusDiv = document.getElementById(elementId);
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = message;
        }
        
        function updateWebSocketStatus(connected) {
            const statusDiv = document.getElementById('wsStatus');
            if (!statusDiv) return;
            
            const indicator = statusDiv.querySelector('.websocket-status');
            if (!indicator) return;
            
            if (connected) {
                indicator.className = 'websocket-status connected';
                statusDiv.innerHTML = '<span class="websocket-status connected"></span>WebSocket: Connected';
                statusDiv.className = 'status success';
            } else {
                indicator.className = 'websocket-status disconnected';
                statusDiv.innerHTML = '<span class="websocket-status disconnected"></span>WebSocket: Disconnected';
                statusDiv.className = 'status error';
            }
        }
        
        function connectWebSocket() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                log('wsLog', 'WebSocket already connected');
                return;
            }
            
            const wsUrl = `ws://localhost:8080/ws/driver-notifications?driverId=${testDriverId}`;
            log('wsLog', `Connecting to: ${wsUrl}`);
            updateStatus('wsStatus', 'info', 'Connecting to WebSocket...');
            
            try {
                ws = new WebSocket(wsUrl);
                
                ws.onopen = function(event) {
                    log('wsLog', 'âœ… WebSocket connected successfully');
                    updateWebSocketStatus(true);
                    isConnected = true;
                };
                
                ws.onmessage = function(event) {
                    log('notificationLog', `ðŸ“¨ Received notification: ${event.data}`);
                    try {
                        const data = JSON.parse(event.data);
                        log('notificationLog', `ðŸ“¨ Parsed notification: ${JSON.stringify(data, null, 2)}`);
                        
                        if (data.type === 'RIDE_REQUEST') {
                            updateStatus('notificationStatus', 'success', 'ðŸŽ‰ Ride request notification received!');
                            log('completeTestLog', 'âœ… SUCCESS: Driver received ride request notification');
                        }
                    } catch (e) {
                        log('notificationLog', `ðŸ“¨ Raw notification: ${event.data}`);
                    }
                };
                
                ws.onerror = function(error) {
                    log('wsLog', `âŒ WebSocket error: ${error}`);
                    updateWebSocketStatus(false);
                };
                
                ws.onclose = function(event) {
                    log('wsLog', `ðŸ”Œ WebSocket closed. Code: ${event.code}, Reason: ${event.reason}`);
                    updateWebSocketStatus(false);
                    isConnected = false;
                };
                
            } catch (error) {
                log('wsLog', `âŒ Error creating WebSocket: ${error.message}`);
                updateWebSocketStatus(false);
            }
        }
        
        function disconnectWebSocket() {
            if (ws) {
                ws.close();
                log('wsLog', 'ðŸ”Œ Manually disconnected WebSocket');
            }
        }
        
        async function checkConnectedDrivers() {
            try {
                log('driverLog', 'ðŸ” Checking connected drivers...');
                const response = await fetch('http://localhost:8080/api/bookings/connected-drivers');
                const drivers = await response.json();
                
                log('driverLog', `âœ… Found ${drivers.length} connected drivers`);
                log('driverLog', `ðŸ“‹ Driver IDs: ${drivers.join(', ') || 'None'}`);
                
                if (drivers.includes(testDriverId)) {
                    updateStatus('driverStatus', 'success', `âœ… Test driver '${testDriverId}' is connected`);
                } else {
                    updateStatus('driverStatus', 'warning', `âš ï¸ Test driver '${testDriverId}' not found in connected drivers`);
                }
                
            } catch (error) {
                log('driverLog', `âŒ Error checking drivers: ${error.message}`);
                updateStatus('driverStatus', 'error', 'âŒ Failed to check connected drivers');
            }
        }
        
        async function createTestBooking() {
            const bookingData = {
                riderId: 'testrider',
                pickupLocation: '12.9716,77.5946',
                destinationLocation: '12.9789,77.5917',
                distance: 2.5,
                duration: 8,
                price: 50
            };
            
            log('bookingLog', `ðŸš€ Creating test booking...`);
            log('bookingLog', `ðŸ“‹ Booking data: ${JSON.stringify(bookingData, null, 2)}`);
            
            try {
                const response = await fetch('http://localhost:8080/api/bookings/with-notification', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(bookingData)
                });
                
                if (response.ok) {
                    const booking = await response.json();
                    log('bookingLog', `âœ… Booking created successfully! ID: ${booking.id}`);
                    updateStatus('bookingStatus', 'success', 'âœ… Test booking created and notifications sent');
                    log('completeTestLog', 'âœ… SUCCESS: Test booking created successfully');
                } else {
                    const errorText = await response.text();
                    log('bookingLog', `âŒ Booking failed: ${response.status} - ${errorText}`);
                    updateStatus('bookingStatus', 'error', `âŒ Booking failed: ${response.status}`);
                }
                
            } catch (error) {
                log('bookingLog', `âŒ Error creating booking: ${error.message}`);
                updateStatus('bookingStatus', 'error', 'âŒ Failed to create booking');
            }
        }
        
        async function createBookingWithDriver() {
            const bookingData = {
                riderId: 'testrider',
                pickupLocation: '12.9716,77.5946',
                destinationLocation: '12.9789,77.5917',
                distance: 2.5,
                duration: 8,
                price: 50,
                driverId: testDriverId
            };
            
            log('bookingLog', `ðŸš€ Creating booking for specific driver: ${testDriverId}`);
            
            try {
                const response = await fetch('http://localhost:8080/api/bookings/with-notification', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(bookingData)
                });
                
                if (response.ok) {
                    const booking = await response.json();
                    log('bookingLog', `âœ… Booking created for driver ${testDriverId}! ID: ${booking.id}`);
                    updateStatus('bookingStatus', 'success', `âœ… Booking created for driver ${testDriverId}`);
                } else {
                    const errorText = await response.text();
                    log('bookingLog', `âŒ Booking failed: ${response.status} - ${errorText}`);
                    updateStatus('bookingStatus', 'error', `âŒ Booking failed: ${response.status}`);
                }
                
            } catch (error) {
                log('bookingLog', `âŒ Error creating booking: ${error.message}`);
                updateStatus('bookingStatus', 'error', 'âŒ Failed to create booking');
            }
        }
        
        async function runCompleteTest() {
            log('completeTestLog', 'ðŸš€ Starting complete notification flow test...');
            
            // Step 1: Connect WebSocket
            log('completeTestLog', 'Step 1: Connecting WebSocket...');
            connectWebSocket();
            
            // Step 2: Wait for connection and check drivers
            setTimeout(async () => {
                log('completeTestLog', 'Step 2: Checking connected drivers...');
                await checkConnectedDrivers();
                
                // Step 3: Create test booking
                setTimeout(async () => {
                    log('completeTestLog', 'Step 3: Creating test booking...');
                    await createTestBooking();
                    
                    log('completeTestLog', 'âœ… Complete test finished. Check notification logs for results.');
                }, 1000);
            }, 2000);
        }
        
        function clearAllLogs() {
            document.getElementById('wsLog').innerHTML = '';
            document.getElementById('driverLog').innerHTML = '';
            document.getElementById('bookingLog').innerHTML = '';
            document.getElementById('notificationLog').innerHTML = '';
            document.getElementById('completeTestLog').innerHTML = '';
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('completeTestLog', 'ðŸš€ Driver notification flow test page loaded');
            updateWebSocketStatus(false);
        });
    </script>
</body>
</html> 